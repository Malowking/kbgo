version: '3.8'

# 这个文件会自动被 docker-compose 加载，用于覆盖默认配置
# 完整模式（--profile full）会应用所有配置
# 默认模式只会应用 kbgo 的基础配置

services:
  kbgo:
    environment:
      # 文件解析服务（两种模式都需要，因为 file-parse 都会启动）
      GF_FILEPARSE_URL: http://file-parse:8002
      # 使用本地存储
      GF_STORAGE_TYPE: local

      # 以下配置仅在 full profile 时生效（需要数据库容器）
      # 默认模式会从 config.yaml 读取本地数据库配置
      GF_DATABASE_DEFAULT_HOST: ${DB_HOST:-host.docker.internal}
      GF_DATABASE_DEFAULT_PORT: ${DB_PORT:-5432}
      GF_DATABASE_DEFAULT_USER: ${DB_USER:-kbgo}
      GF_DATABASE_DEFAULT_PASS: ${DB_PASS:-kbgo123}
      GF_DATABASE_DEFAULT_NAME: ${DB_NAME:-kbgo}
      GF_DATABASE_DEFAULT_TYPE: ${DB_TYPE:-pgsql}

      # PostgreSQL 向量数据库配置
      GF_POSTGRES_HOST: ${POSTGRES_HOST:-host.docker.internal}
      GF_POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      GF_POSTGRES_USER: ${POSTGRES_USER:-kbgo}
      GF_POSTGRES_PASSWORD: ${POSTGRES_PASS:-kbgo123}
      GF_POSTGRES_DATABASE: ${POSTGRES_DB:-kbgo}

      # 向量存储类型
      GF_VECTORSTORE_TYPE: ${VECTORSTORE_TYPE:-pgvector}

    # 条件依赖：只有在 full profile 时才依赖 postgres
    depends_on:
      file-parse:
        condition: service_started